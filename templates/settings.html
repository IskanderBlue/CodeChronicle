{% extends 'base.html' %}

{% block title %}CodeChronicle - Settings{% endblock %}
{% block extra_head %}
<script>
    (function () {
        const PDF_DB_NAME = 'codechronicle_pdf_cache';
        const PDF_DB_VERSION = 1;
        const PDF_DB_STORE = 'pdf_mappings';

        function humanBytes(value) {
            if (!Number.isFinite(value) || value <= 0) return '0 B';
            const units = ['B', 'KB', 'MB', 'GB'];
            let size = value;
            let unit = 0;
            while (size >= 1024 && unit < units.length - 1) {
                size /= 1024;
                unit += 1;
            }
            const decimals = unit === 0 ? 0 : 1;
            return `${size.toFixed(decimals)} ${units[unit]}`;
        }

        function getPdfDb() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(PDF_DB_NAME, PDF_DB_VERSION);
                request.onupgradeneeded = () => {
                    const db = request.result;
                    if (!db.objectStoreNames.contains(PDF_DB_STORE)) {
                        db.createObjectStore(PDF_DB_STORE, { keyPath: 'expected_key' });
                    }
                };
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error || new Error('Could not open IndexedDB.'));
            });
        }

        async function mappingCount() {
            const db = await getPdfDb();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(PDF_DB_STORE, 'readonly');
                const request = tx.objectStore(PDF_DB_STORE).count();
                request.onsuccess = () => resolve(Number(request.result) || 0);
                request.onerror = () => reject(request.error || new Error('Could not read PDF mapping count.'));
            });
        }

        async function clearMappings() {
            const db = await getPdfDb();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(PDF_DB_STORE, 'readwrite');
                tx.oncomplete = () => resolve(undefined);
                tx.onerror = () => reject(tx.error || new Error('Could not clear PDF mappings.'));
                tx.objectStore(PDF_DB_STORE).clear();
            });
        }

        async function refreshStorageUi(controls) {
            const usageLabel = controls.querySelector('[data-pdf-storage-usage]');
            const engineLabel = controls.querySelector('[data-pdf-storage-engine]');
            const clearButton = controls.querySelector('[data-pdf-clear-cache]');

            let count = 0;
            try {
                count = await mappingCount();
            } catch (err) {
                console.error(err);
            }

            let usageText = `${count} mapped file${count === 1 ? '' : 's'}`;
            if (navigator.storage && navigator.storage.estimate) {
                try {
                    const estimate = await navigator.storage.estimate();
                    usageText += ` | Storage: ${humanBytes(estimate.usage || 0)} / ${humanBytes(estimate.quota || 0)}`;
                } catch (err) {
                    console.error('Storage estimate failed:', err);
                }
            }

            if (usageLabel) usageLabel.textContent = usageText;
            if (engineLabel) {
                const opfsAvailable = !!(navigator.storage && navigator.storage.getDirectory);
                engineLabel.textContent = opfsAvailable ? 'IndexedDB cache (OPFS available)' : 'IndexedDB cache';
            }
            if (clearButton) clearButton.disabled = count === 0;
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const controls = document.querySelector('[data-pdf-storage-controls]');
            if (!controls || !window.indexedDB) return;

            const clearButton = controls.querySelector('[data-pdf-clear-cache]');
            if (clearButton) {
                clearButton.addEventListener('click', async () => {
                    await clearMappings();
                    await refreshStorageUi(controls);
                });
            }

            await refreshStorageUi(controls);
        });
    })();
</script>
{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto px-4 py-8"
    x-data="{ tab: window.location.hash === '#account' ? 'account' : 'general' }"
    x-init="$watch('tab', val => window.location.hash = val)">
    <h1 class="text-2xl font-bold text-neutral-900 dark:text-white mb-6">Settings</h1>

    <!-- Tabs -->
    <div class="border-b border-neutral-200 dark:border-neutral-700 mb-6">
        <nav class="-mb-px flex space-x-8">
            <button @click="tab = 'general'" type="button"
                :class="tab === 'general'
                    ? 'border-primary-500 text-primary-600 dark:text-primary-400'
                    : 'border-transparent text-neutral-500 dark:text-neutral-400 hover:text-neutral-700 dark:hover:text-neutral-200 hover:border-neutral-300 dark:hover:border-neutral-600'"
                class="whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">
                General
            </button>
            <button @click="tab = 'account'" type="button"
                :class="tab === 'account'
                    ? 'border-primary-500 text-primary-600 dark:text-primary-400'
                    : 'border-transparent text-neutral-500 dark:text-neutral-400 hover:text-neutral-700 dark:hover:text-neutral-200 hover:border-neutral-300 dark:hover:border-neutral-600'"
                class="whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">
                Account
            </button>
        </nav>
    </div>

    <!-- General Tab -->
    <div x-show="tab === 'general'" x-cloak>
        <div class="bg-neutral-100 dark:bg-neutral-800 shadow sm:rounded-lg overflow-hidden border border-neutral-200 dark:border-neutral-700">
            <div class="px-4 py-5 sm:p-6">
                <h2 class="text-lg font-medium text-neutral-900 dark:text-white mb-1">Local PDF Cache</h2>
                <p class="text-sm text-neutral-500 dark:text-neutral-400 mb-4">
                    PDF mappings are stored in your browser only. Clear cached files here if you need to reset mappings.
                </p>
                <div class="rounded-md border border-neutral-200 dark:border-neutral-700 bg-neutral-100 dark:bg-neutral-800 px-4 py-3"
                    data-pdf-storage-controls>
                    <p class="text-xs text-neutral-500 dark:text-neutral-400">
                        <span data-pdf-storage-engine>IndexedDB cache</span>
                        <span class="mx-1">|</span>
                        <span data-pdf-storage-usage>0 mapped files</span>
                    </p>
                    <div class="mt-3">
                        <button type="button" data-pdf-clear-cache
                            class="inline-flex items-center px-2.5 py-1.5 text-xs font-medium rounded border border-neutral-300 dark:border-neutral-600 text-neutral-600 dark:text-neutral-300 hover:bg-neutral-200 dark:hover:bg-neutral-700 disabled:opacity-50 disabled:cursor-not-allowed">
                            Clear cached PDFs
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="mt-6 bg-neutral-100 dark:bg-neutral-800 shadow sm:rounded-lg overflow-hidden border border-neutral-200 dark:border-neutral-700">
            <div class="px-4 py-5 sm:p-6">

                <h3 class="text-sm font-semibold text-neutral-900 dark:text-neutral-100 uppercase tracking-wider">
                    Expected PDF Filenames
                </h3>
                <p class="mt-2 text-xs text-neutral-500 dark:text-neutral-400">
                    Use these expected filenames when mapping files from search results.
                </p>
                <div class="mt-3 overflow-x-auto">
                    <table class="min-w-full text-sm text-left border border-neutral-200 dark:border-neutral-700">
                        <thead class="bg-neutral-200 dark:bg-neutral-900/50 text-neutral-600 dark:text-neutral-400">
                            <tr>
                                <th class="px-3 py-2 font-medium">Code</th>
                                <th class="px-3 py-2 font-medium">Effective Date</th>
                                <th class="px-3 py-2 font-medium">Map Code</th>
                                <th class="px-3 py-2 font-medium">Filename</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-neutral-200 dark:divide-neutral-700 text-neutral-700 dark:text-neutral-300">
                            {% for row in pdf_expectations %}
                            <tr class="bg-neutral-100 dark:bg-neutral-800">
                                <td class="px-3 py-2 whitespace-nowrap">{{ row.system }}_{{ row.year }}</td>
                                <td class="px-3 py-2 whitespace-nowrap">{{ row.effective_date }}</td>
                                <td class="px-3 py-2 whitespace-nowrap">{{ row.map_code }}</td>
                                <td class="px-3 py-2 whitespace-nowrap font-mono text-xs">
                                    {% if row.download_url %}
                                    <a class="text-primary-600 dark:text-primary-400 underline font-medium"
                                        href="{{ row.download_url }}" target="_blank" rel="noopener noreferrer">
                                        {{ row.filename }}
                                    </a>
                                    {% else %}
                                    {{ row.filename }}
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr class="bg-neutral-100 dark:bg-neutral-800">
                                <td class="px-3 py-3 text-center text-neutral-500 dark:text-neutral-400" colspan="4">
                                    No PDF filenames configured.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Account Tab -->
    <div x-show="tab === 'account'" x-cloak>
        <!-- Sign Out -->
        <div class="my-6 bg-neutral-100 dark:bg-neutral-800 shadow sm:rounded-lg overflow-hidden border border-neutral-200 dark:border-neutral-700">
            <div class="px-4 py-5 sm:p-6">
                <h2 class="text-lg font-medium text-neutral-900 dark:text-white mb-1">Sign Out</h2>
                <p class="text-sm text-neutral-500 dark:text-neutral-400 mb-4">
                    Sign out of your CodeChronicle account on this device.
                </p>
                <form method="POST" action="{% url 'account_logout' %}">
                    {% csrf_token %}
                    {% if redirect_field_value %}
                    <input type="hidden" name="{{ redirect_field_name }}" value="{{ redirect_field_value }}" />
                    {% endif %}
    
                    <div class="flex justify-left space-y-4">
                        <button type="submit"
                            class="min-w-40 py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                            Sign Out
                        </button>
                    </div>
                </form>
                <!--<a href="{% url 'account_logout' %}"
                    class="inline-flex items-center px-4 py-2 border border-danger-300 dark:border-danger-700 text-sm font-medium rounded-md text-danger-700 dark:text-danger-400 bg-white dark:bg-neutral-900 hover:bg-danger-50 dark:hover:bg-danger-900/20 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-danger-500 shadow-sm">
                    Sign Out
                </a>-->
            </div>
        </div>

        <!-- Change Password -->
        <div class="bg-neutral-100 dark:bg-neutral-800 shadow sm:rounded-lg overflow-hidden border border-neutral-200 dark:border-neutral-700">
            <div class="px-4 py-5 sm:p-6">
                <h2 class="text-lg font-medium text-neutral-900 dark:text-white mb-1">Change Password</h2>
                <p class="text-sm text-neutral-500 dark:text-neutral-400 mb-4">
                    Keep your account secure with a strong password.
                </p>

                <form method="post" action="{% url 'account_change_password' %}" class="space-y-4">
                    {% csrf_token %}
                    {% for field in password_form %}
                    <div>
                        <label for="{{ field.id_for_label }}"
                            class="block text-sm font-medium text-neutral-700 dark:text-neutral-300">
                            {{ field.label }}
                        </label>
                        <div class="mt-1">
                            <input id="{{ field.id_for_label }}" name="{{ field.name }}" type="password" required
                                class="appearance-none block w-full px-3 py-2 border border-neutral-300 dark:border-neutral-600 bg-white dark:bg-neutral-900 rounded-md shadow-sm placeholder-neutral-400 dark:placeholder-neutral-500 text-neutral-900 dark:text-white focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm">
                        </div>
                        {% if field.help_text %}
                        <p class="mt-1 text-xs text-neutral-500 dark:text-neutral-400">{{ field.help_text|safe }}</p>
                        {% endif %}
                    </div>
                    {% endfor %}
                    <div class="flex justify-left">
                        <button type="submit"
                            class="min-w-40 px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 shadow-sm">
                            Change Password
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
