{% extends 'base.html' %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/5.4.149/pdf_viewer.min.css">
<script type="module">
import * as pdfjsLib from 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/5.4.149/pdf.min.mjs';
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/5.4.149/pdf.worker.min.mjs';

const pdfCache = {};

function loadPdf(url) {
    if (!pdfCache[url]) {
        pdfCache[url] = pdfjsLib.getDocument(url).promise;
    }
    return pdfCache[url];
}

async function renderPdfPage(container, url, pageNum, bbox) {
    try {
        const pdf = await loadPdf(url);
        const page = await pdf.getPage(pageNum);

        const containerWidth = container.clientWidth || 600;
        const unscaledViewport = page.getViewport({ scale: 1 });
        const scale = containerWidth / unscaledViewport.width;
        const viewport = page.getViewport({ scale });
        const pageHeight = unscaledViewport.height;

        // Create wrapper
        const wrapper = document.createElement('div');
        wrapper.className = 'pdf-page';
        wrapper.style.position = 'relative';
        wrapper.style.width = viewport.width + 'px';
        wrapper.style.height = viewport.height + 'px';

        // Canvas for rendering
        const canvas = document.createElement('canvas');
        const dpr = window.devicePixelRatio || 1;
        canvas.width = Math.floor(viewport.width * dpr);
        canvas.height = Math.floor(viewport.height * dpr);
        canvas.style.width = viewport.width + 'px';
        canvas.style.height = viewport.height + 'px';
        wrapper.appendChild(canvas);

        const ctx = canvas.getContext('2d');
        ctx.scale(dpr, dpr);
        await page.render({ canvasContext: ctx, viewport }).promise;

        // Highlight bbox region and offset to focus on it
        if (bbox) {
            const x = bbox.l * scale;
            const y = (pageHeight - bbox.t) * scale;
            const w = (bbox.r - bbox.l) * scale;
            const h = (bbox.t - bbox.b) * scale;

            const highlight = document.createElement('div');
            highlight.className = 'pdf-bbox-highlight';
            highlight.style.cssText = `position:absolute;left:${x}px;top:${y}px;width:${w}px;height:${h}px;`;
            wrapper.appendChild(highlight);

            // Shift page up so bbox is visible in collapsed view (overflow-hidden)
            const offset = Math.max(0, y - 10);
            wrapper.style.marginTop = -offset + 'px';
        }

        // Text layer for selection
        const textContent = await page.getTextContent();
        const textLayerDiv = document.createElement('div');
        textLayerDiv.className = 'textLayer';
        textLayerDiv.style.setProperty('--scale-factor', scale);
        wrapper.appendChild(textLayerDiv);

        const tl = new pdfjsLib.TextLayer({
            textContentSource: textContent,
            container: textLayerDiv,
            viewport: viewport,
        });
        await tl.render();

        container.innerHTML = '';
        container.appendChild(wrapper);
        return true;
    } catch (err) {
        container.classList.add('flex', 'items-center', 'justify-center', 'text-center', 'text-xs', 'text-neutral-400', 'italic');
        container.classList.remove('cursor-pointer');
        container.innerHTML = 'Could not load PDF page. Check your directory path and file names under&nbsp;<a href="/settings/" class="text-primary-600 dark:text-primary-400 underline font-medium" onclick="event.stopPropagation()">Settings</a>.';
        console.error('PDF render error:', err);
        return false;
    }
}

function parseBbox(str) {
    if (!str) return null;
    const parts = str.split(',').map(Number);
    if (parts.length !== 4 || parts.some(isNaN)) return null;
    return { l: parts[0], t: parts[1], r: parts[2], b: parts[3] };
}

function showPdfWarning(container, message) {
    const block = container.closest('[data-pdf-block]');
    if (!block) return;
    const warning = block.querySelector('[data-pdf-warning]');
    if (warning) {
        warning.textContent = message;
        warning.classList.remove('hidden');
    }
    const fallback = block.querySelector('[data-pdf-fallback]');
    if (fallback) {
        fallback.classList.remove('hidden');
    }
}

function initPdfContainers(root) {
    const containers = (root || document).querySelectorAll('[data-pdf-url]:not([data-pdf-loaded])');
    containers.forEach(el => {
        el.setAttribute('data-pdf-loaded', 'true');
        const url = el.getAttribute('data-pdf-url');
        const page = parseInt(el.getAttribute('data-pdf-page'), 10) || 1;
        const bbox = parseBbox(el.getAttribute('data-pdf-bbox'));
        renderPdfPage(el, url, page, bbox);
    });
}

// Init after HTMX injects results
document.addEventListener('htmx:afterSettle', (e) => {
    initPdfContainers(e.detail.elt);
});
document.addEventListener('DOMContentLoaded', () => {
    initPdfContainers();
});
</script>
<style>
    .pdf-page {
        position: relative;
    }
    .pdf-page .textLayer {
        position: absolute;
        left: 0;
        top: 0;
        right: 0;
        bottom: 0;
        overflow: hidden;
        opacity: 0.25;
        line-height: 1;
    }
    .pdf-page .textLayer ::selection {
        background: rgba(0, 100, 200, 0.4);
    }
    .pdf-bbox-highlight {
        background: rgba(14, 165, 133, 0.08);
        border: 2px solid rgba(14, 165, 133, 0.4);
        border-radius: 2px;
        pointer-events: none;
    }
    .pdf-collapse-gradient {
        --fade-color: #fff;
        background: linear-gradient(transparent 60%, var(--fade-color) 100%);
    }
    .dark .pdf-collapse-gradient {
        --fade-color: rgb(38 38 38);
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-8">
    <div class="text-center mb-12">
        <h1 class="text-4xl font-extrabold text-neutral-900 dark:text-white sm:text-5xl">
            Historical Building Code Search
        </h1>
        <p class="mt-4 text-xl text-neutral-500 dark:text-neutral-400">
            Find building code requirements for any construction or renovation date.
        </p>
    </div>

    <!-- Search Form -->
    <div
        class="bg-white dark:bg-neutral-800 shadow sm:rounded-lg overflow-hidden border border-neutral-200 dark:border-neutral-700">
        <div class="px-4 py-5 sm:p-6">
            <form hx-post="{% url 'core:search_results' %}" hx-target="#results-area"
                hx-on::before-request="document.getElementById('results-area').innerHTML=document.getElementById('loading-tpl').innerHTML"
                class="space-y-4">
                {% csrf_token %}
                <div class="flex flex-col sm:flex-row gap-4">
                    <div class="flex-grow">
                        <label for="query" class="sr-only">Query</label>
                        <input type="text" name="query" id="query"
                            class="block w-full rounded-md border-neutral-300 dark:border-neutral-600 bg-white dark:bg-neutral-900 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm p-3 border dark:text-neutral-100 dark:placeholder-neutral-500"
                            placeholder="e.g. fire safety for house built in 1993 in Ontario"
                            value="{{ initial_query }}" required>
                    </div>
                    <button type="submit"
                        class="inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 shadow-sm">
                        Search
                    </button>
                </div>

                <!-- Advanced Options (Alpine.js) -->
                <div x-data="{ open: false }">
                    <button type="button" @click="open = !open"
                        class="text-sm text-primary-600 dark:text-primary-400 hover:text-primary-500 font-medium flex items-center">
                        <span x-text="open ? 'Hide advanced options' : 'Show advanced options'"></span>
                        <svg class="ml-1 h-4 w-4 transform transition-transform" :class="open ? 'rotate-180' : ''"
                            fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>

                    <div x-show="open" x-cloak x-transition
                        class="mt-4 p-4 bg-neutral-50 dark:bg-neutral-900/50 rounded-md border border-neutral-100 dark:border-neutral-700/50 grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label
                                class="block text-xs font-medium text-neutral-500 dark:text-neutral-400 uppercase tracking-wider">Province</label>
                            <select name="province"
                                class="mt-1 block w-full rounded-md border-neutral-300 dark:border-neutral-600 bg-white dark:bg-neutral-800 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm border p-2 dark:text-neutral-100">
                                <option value="ON">Ontario</option>
                                <!-- Other provinces omitted for initial release -->
                            </select>
                        </div>
                        <div>
                            <label
                                class="block text-xs font-medium text-neutral-500 dark:text-neutral-400 uppercase tracking-wider">Effective
                                Date</label>
                            <input type="date" name="date"
                                class="mt-1 block w-full rounded-md border-neutral-300 dark:border-neutral-600 bg-white dark:bg-neutral-800 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm border p-2 dark:text-neutral-100">
                            <p class="mt-1 text-xs text-neutral-400 dark:text-neutral-500 italic">Optional: Overrides
                                date in query</p>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Loading indicator template (hidden, cloned into results area on submit) -->
    <div id="loading-tpl" class="hidden">
        <div class="text-center py-12">
            <svg class="animate-spin mx-auto h-8 w-8 text-accent-500"
                xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                </path>
            </svg>
            <p class="mt-3 text-sm font-medium text-accent-600 dark:text-accent-400">
                Analyzing query and searching codes...
            </p>
        </div>
    </div>

    <!-- Results Area -->
    <div id="results-area" class="mt-8 space-y-6">
        <!-- Results will be injected here by HTMX -->
        <div class="text-center py-12 opacity-50">
            <svg class="mx-auto h-12 w-12 text-neutral-400 dark:text-neutral-500" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            <h3 class="mt-2 text-sm font-medium text-neutral-900 dark:text-neutral-300">No search performed yet</h3>
            <p class="mt-1 text-sm text-neutral-500 dark:text-neutral-400">Ask a question about building codes to get
                started.</p>
        </div>
    </div>

    {% if initial_query %}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        var form = document.querySelector('[hx-post]');
        if (form) {
            document.getElementById('results-area').innerHTML =
                document.getElementById('loading-tpl').innerHTML;
            htmx.trigger(form, 'submit');
        }
    });
    </script>
    {% endif %}
</div>
{% endblock %}
